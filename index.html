<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>WebRTC DataChannel Test</title>
</head>
<body>
  <h2>WebRTC DataChannel クライアント</h2>
  <button id="sendBtn">DataChannelで送信</button>
  <pre id="log"></pre>
  <script>
    let ws, pc, dataChannel;

    function log(msg) {
      document.getElementById('log').textContent += msg + '\n';
    }

    ws = new WebSocket("ws://localhost:8080/ws");

    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === "offer") {
        pc = new RTCPeerConnection();
        pc.onicecandidate = e => {
          if (e.candidate) {
            ws.send(JSON.stringify({ type: "candidate", candidate: e.candidate }));
          }
        };

        pc.ondatachannel = e => {
          dataChannel = e.channel;
          dataChannel.onopen = () => {
            log('DataChannel open!');
          };
          dataChannel.onmessage = (ev) => {
            log("サーバから受信: " + ev.data);
          };
        };

        await pc.setRemoteDescription(msg.offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: "answer", answer }));
      } else if (msg.type === "candidate" && pc) {
        await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
      }
    };

    document.getElementById('sendBtn').onclick = () => {
      if (dataChannel && dataChannel.readyState === "open") {
        dataChannel.send("こんにちは、サーバ！");
        log("クライアント→サーバへ送信: こんにちは、サーバ！");
      }
    };
  </script>
</body>
</html>
